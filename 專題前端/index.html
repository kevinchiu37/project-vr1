<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>詐騙檢測</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="m-0 p-0">
  <div class="flex h-screen">
    <!-- 左側導覽列 -->
    <div class="w-[250px] bg-gray-100 p-5 shadow-md fixed h-full overflow-y-auto">
      <button id="home-btn"
        class="mb-4 bg-gray-800 text-white w-12 h-12 rounded-full shadow flex items-center justify-center hover:bg-gray-700"
        aria-label="回到首頁">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
        </svg>
      </button>
      <h3 class="text-xl font-semibold mb-4">歷史紀錄</h3>
      <ul id="history-list" class="space-y-2"></ul>
    </div>

    <!-- 右側內容 -->
    <div class="ml-[250px] w-[calc(100%-250px)] relative px-4 bg-cover bg-center h-screen overflow-y-auto"
         style="background-image:url('https://newscrewdriver.files.wordpress.com/2018/10/poptartcat320240.gif')">

      <!-- 背景遮罩 -->
      <div class="fixed top-0 left-[250px] w-[calc(100%-250px)] h-full z-0 pointer-events-none">
        <div class="w-full h-full bg-black bg-opacity-40 backdrop-blur-md"></div>
      </div>

      <!-- 對話與輸入 -->
      <div class="relative z-10 max-w-[700px] mx-auto pt-[100px] pb-10 flex flex-col space-y-6">
        <div id="chat-container"
             class="hidden flex flex-col space-y-4 overflow-y-auto bg-white/70 backdrop-blur-md rounded-2xl shadow p-4 max-h-[60vh]">
        </div>

        <div id="input-section-wrapper"
             class="bg-white/70 backdrop-blur-md rounded-2xl shadow px-4 py-3 flex flex-col space-y-3">
          <div class="text-4xl font-bold text-center mb-4">請上傳圖片或連結</div>
          <div class="flex space-x-2">
            <input id="chat-input" type="text" placeholder="輸入訊息..."
                   class="flex-grow border border-gray-300 rounded-lg px-3 py-2 text-lg focus:outline-none" />
            <input id="image-input" type="file" accept="image/*" class="hidden" />
            <label for="image-input"
                   class="bg-gray-200 text-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-300">上傳圖片</label>
            <button id="send-btn"
                    class="bg-black text-white rounded-lg px-4 py-2 hover:opacity-90">輸出</button>
          </div>
          <div id="image-preview" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 儲存按鈕 -->
  <button id="save-btn"
          class="fixed bottom-5 right-5 bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg hidden hover:bg-blue-700"
          aria-label="儲存進歷史紀錄">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
         stroke="currentColor" class="size-10">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
    </svg>
  </button>

  <script>
    const API_BASE = 'http://localhost:5000';

    const sendBtn = document.getElementById('send-btn');
    const saveBtn = document.getElementById('save-btn');
    const chatInput = document.getElementById('chat-input');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    const chatContainer = document.getElementById('chat-container');
    const historyList = document.getElementById('history-list');
    const inputSection = document.getElementById('input-section-wrapper');
    const homeBtn = document.getElementById('home-btn');

    let lastContent = null;
    const historyData = [];

    imageInput.addEventListener('change', () => {
      imagePreview.innerHTML = '';
      const file = imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'max-w-xs rounded border p-2';
        imagePreview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });

    sendBtn.addEventListener('click', async () => {
      const message = chatInput.value.trim();
      const file = imageInput.files[0];

      if (!message && !file) {
        alert("請輸入文字或上傳圖片");
        return;
      }

      chatContainer.style.display = 'flex';

      if (file) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.className = 'self-end max-w-[200px] rounded-xl shadow border';
        chatContainer.appendChild(img);
      }
      if (message) {
        const userBubble = document.createElement('div');
        userBubble.className = 'self-end bg-blue-600 text-white p-3 rounded-xl max-w-[70%] shadow';
        userBubble.textContent = message;
        chatContainer.appendChild(userBubble);
      }

      const aiBubble = document.createElement('div');
      aiBubble.className = 'self-start bg-white text-black p-3 rounded-xl max-w-[70%] shadow';
      aiBubble.textContent = '正在分析中...';
      chatContainer.appendChild(aiBubble);

      try {
        const formData = new FormData();
        if (file) formData.append('image', file);
        formData.append('text', message);

        const res = await fetch(`${API_BASE}/analyze-all`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();


      if (data.error) {
        if (data.error === 'OCR_API_ERROR' && data.details) {
          aiBubble.textContent = `❌ 圖片辨識錯誤：${data.details}`;
        } else {
          aiBubble.textContent = `❌ 錯誤：${data.error}`;
        }
      } else {
        aiBubble.textContent = `分析結果：${data.final_label}（score: ${data.total_score}）`;
      }

        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            lastContent = {
              message: message || null,
              image: e.target.result
            };
            saveBtn.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          lastContent = {
            message: message || null,
            image: null
          };
          saveBtn.style.display = 'block';
        }
      } catch (err) {
        aiBubble.textContent = "分析失敗，請稍後再試";
        console.error(err);
      }

      chatInput.value = '';
      imageInput.value = '';
      imagePreview.innerHTML = '';
    });

    saveBtn.addEventListener('click', () => {
      if (!lastContent) return;

      if (historyData.length >= 20) {
        historyData.pop();
        historyList.removeChild(historyList.lastChild);
      }

      const copy = { ...lastContent };
      historyData.unshift(copy);

      const item = document.createElement('div');
      item.className = 'flex justify-between items-center bg-white px-2 py-1 rounded hover:bg-gray-100';

      const label = document.createElement('span');
      label.className = 'text-gray-700 text-sm cursor-pointer hover:underline flex-1';
      label.textContent = copy.message
        ? (copy.message.length > 8 ? copy.message.slice(0, 8) + '...' : copy.message)
        : `圖片訊息 (${new Date().toLocaleTimeString()})`;
      label.onclick = () => {
        restoreHistory(copy);
        inputSection.style.display = 'none';
      };

      const del = document.createElement('button');
      del.textContent = '❌';
      del.className = 'ml-2 text-red-500 hover:text-red-700 text-sm';
      del.onclick = () => {
        const idx = historyData.indexOf(copy);
        if (idx > -1) historyData.splice(idx, 1);
        historyList.removeChild(item);
      };

      item.append(label, del);
      historyList.prepend(item);
      saveBtn.classList.add('hidden');
    });

    function restoreHistory(c) {
      chatContainer.innerHTML = '';
      chatContainer.classList.remove('hidden');

      if (c.image) {
        const img = document.createElement('img');
        img.src = c.image;
        img.className = 'self-end max-w-[200px] rounded-xl shadow border';
        chatContainer.appendChild(img);
      }
      if (c.message) {
        const user = document.createElement('div');
        user.textContent = c.message;
        user.className = 'self-end bg-blue-600 text-white p-3 rounded-xl max-w-[70%] shadow';
        chatContainer.appendChild(user);
      }

      const ai = document.createElement('div');
      ai.textContent = '（歷史紀錄）分析結果';
      ai.className = 'self-start bg-white text-black p-3 rounded-xl max-w-[70%] shadow';
      chatContainer.appendChild(ai);
    }

    homeBtn.onclick = () => {
      chatContainer.innerHTML = '';
      chatContainer.classList.add('hidden');
      inputSection.style.display = 'flex';
      saveBtn.classList.add('hidden');
    };
  </script>
</body>
</html>